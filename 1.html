<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DoseMate Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet">
  <style>
    /* Basic Reset and Font Styles */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", sans-serif; }
    body { background: linear-gradient(135deg, #e0f7fa, #fff3e0); height: 100vh; display: flex;
           background-image: url("logo.jpg");
           background-attachment: fixed;
           background-position: center;
           background-repeat: no-repeat;
     }

    /* Sidebar Styling */
    .sidebar {
      width: 250px; background-color: #263238; color: white;
      padding: 30px 20px; display: flex; flex-direction: column;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }
    .logo {
      font-size: 28px; font-weight: 700; margin-bottom: 40px;
      background: linear-gradient(to right, #4fc3f7, #81c784);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    .sidebar a {
      color: white; text-decoration: none; margin: 15px 0; font-size: 18px;
      transition: 0.3s ease;
      display: block; /* Make the entire link clickable */
    }
    .sidebar a:hover { color: #81c784; }

    /* Main Content Styling (Right side) */
    .main {
      flex: 1; padding: 30px; position: relative;
      display: grid; /* Use a grid layout for cards */
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      align-content: start; /* Align content to the top */
      overflow-y: auto; /* Enable scrolling if there are many cards */
    }

    .header-info {
        grid-column: 1 / -1; /* Make header span all columns */
        text-align: center;
        margin-bottom: 20px;
    }

    /* Medicine Card Styling */
    .medicine-card {
      background-color: #fff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      text-align: center;
    }
    .medicine-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    .medicine-card h3 {
        margin-bottom: 10px;
        color: #263238;
    }
    .medicine-card p {
        font-size: 14px;
        color: #555;
    }
    
    .medicine-card button {
        margin-top: 15px;
        padding: 8px 12px;
        border: none;
        border-radius: 5px;
        background-color: #007bff;
        color: white;
        cursor: pointer;
        font-size: 12px;
    }
    .medicine-card button:hover {
        background-color: #0056b3;
    }

    /* Add Button Styling */
    .add-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: #81c784;
      color: white;
      font-size: 36px;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
      z-index: 100;
      display: flex;
      justify-content: center;
      align-items: center;
      text-decoration: none;
    }
    .add-btn:hover {
      background-color: #4caf50;
      transform: scale(1.1) rotate(90deg);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    .add-btn span {
        transition: transform 0.3s ease;
    }

    /* Modal Styles */
    .modal {
      display: none; position: fixed; top: 0; left: 0;
      width: 100%; height: 100%; background: rgba(0,0,0,0.6);
      justify-content: center; align-items: center; z-index: 1000;
    }
    .modal-content {
      background: white; padding: 30px; border-radius: 10px;
      width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      position: relative; /* Needed for positioning the close button */
    }

    /* New CSS for the close button */
    .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      color: #999;
      cursor: pointer;
      transition: color 0.2s ease;
      background: none;
      border: none;
      padding: 0;
    }
    .close-btn:hover {
      color: #333;
    }

    .modal-content h3 { margin-bottom: 20px; color: #263238; }
    .modal-content input, .modal-content button {
      width: 100%; padding: 10px; margin-bottom: 15px;
      border: 1px solid #ccc; border-radius: 5px;
    }
    .modal-content button {
      background-color: #4caf50; color: white;
      padding: 10px 20px; border: none; border-radius: 5px;
      cursor: pointer;
    }
    .modal-content button:hover { background-color: #388e3c; }

    /* New CSS for Time Input Container */
    .time-input-container {
        width: 100%;
        margin-bottom: 15px;
        text-align: left;
    }
    .time-input-container label {
        display: block;
        font-size: 14px;
        color: #555;
        margin-bottom: 5px;
    }
    
    .recurring-options {
        text-align: left;
        margin-bottom: 15px;
    }
    .recurring-options label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
    }
    .recurring-options input[type="radio"],
    .recurring-options input[type="checkbox"] {
        width: auto;
        margin-right: 5px;
    }
    .days-checkboxes {
        display: none; /* Hide by default */
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }
    .no-medicines {
      font-style: italic;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="logo">DoseMate ðŸ’Š</div>
    <a href="1.html">Dashboard</a>
    <a href="medicines.html">Your Medicines</a>
    <a href="reminders.html">Reminders</a>
    <a href="refill.html">Refill Alerts</a>
    <a href="profile.html">Profile</a>
    <a href="#" onclick="logout()">Logout</a>
  </div>

  <div class="main">
    <div class="header-info">
      <h2>Your Medicines</h2>
      <p>Click the '+' button to add a new medicine reminder.</p>
    </div>
    
    <div id="medicine-list">
      <p class="no-medicines">Loading your medicines...</p>
    </div>
  </div>

  <button class="add-btn" onclick="openModal()">
    <span>+</span>
  </button>

  <div class="modal" id="addModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal()">&times;</button>
      
      <h3>Add Medicine</h3>
      <input type="text" id="medName" placeholder="Medicine Name" />
      <input type="text" id="medDose" placeholder="Dosage (e.g., 1 tablet)" />
      
      <div class="time-input-container">
          <label for="medTime">Set Reminder Time:</label>
          <input type="time" id="medTime" />
      </div>
      
      <div class="recurring-options">
        <label>
            <input type="radio" name="recurrence" value="daily" checked onclick="toggleDays(false)"> Daily
        </label>
        <label>
            <input type="radio" name="recurrence" value="specific" onclick="toggleDays(true)"> Specific Days
        </label>
        <div id="daysCheckboxes" class="days-checkboxes">
          <label><input type="checkbox" name="day" value="mon"> Mon</label>
          <label><input type="checkbox" name="day" value="tue"> Tue</label>
          <label><input type="checkbox" name="day" value="wed"> Wed</label>
          <label><input type="checkbox" name="day" value="thu"> Thu</label>
          <label><input type="checkbox" name="day" value="fri"> Fri</label>
          <label><input type="checkbox" name="day" value="sat"> Sat</label>
          <label><input type="checkbox" name="day" value="sun"> Sun</label>
        </div>
      </div>
      
      <button onclick="saveMedicine()">Add</button>
    </div>
  </div>

  <script type="module">
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

    // Firebase configuration object
    const firebaseConfig = {
      apiKey: "AIzaSyBbq0tDMH4vXUwBGTA1z_4KqfCQjqEhSLI",
      authDomain: "dose-mate-70662.firebaseapp.com",
      projectId: "dose-mate-70662",
      storageBucket: "dose-mate-70662.appspot.com",
      messagingSenderId: "222253636993",
      appId: "1:222253636993:web:56db06bd0f02c5df6b5c80"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let user;
    let medData = [];
    const medicineList = document.getElementById("medicine-list");
    const modal = document.getElementById("addModal");
    const medNameInput = document.getElementById("medName");
    const medDoseInput = document.getElementById("medDose");
    const medTimeInput = document.getElementById("medTime");
    const daysCheckboxes = document.getElementById("daysCheckboxes");

    onAuthStateChanged(auth, (authUser) => {
      if (authUser) {
        user = authUser;
        fetchMedicines();
      } else {
        window.location.href = "index.html";
      }
    });

    async function fetchMedicines() {
      const q = query(collection(db, "medicines"), where("userId", "==", user.uid));
      onSnapshot(q, (snapshot) => {
        medData = [];
        snapshot.forEach((doc) => {
          medData.push({ id: doc.id, ...doc.data() });
        });
        displayMedicines();
      });
    }

    function displayMedicines() {
      medicineList.innerHTML = '';
      if (medData.length === 0) {
        medicineList.innerHTML = "<p class='no-medicines'>You have no medicines added yet.</p>";
        return;
      }
      medData.forEach(med => {
        const card = document.createElement("div");
        card.className = "medicine-card";
        
        let recurrenceText = "Daily";
        if (med.recurrence === "specific" && med.days.length > 0) {
            recurrenceText = med.days.map(day => day.charAt(0).toUpperCase() + day.slice(1)).join(', ');
        } else if (med.recurrence === "specific" && med.days.length === 0) {
            recurrenceText = "No days selected";
        }

        card.innerHTML = `
          <h3>${med.name}</h3>
          <p><strong>Dose:</strong> ${med.dose}</p>
          <p><strong>Time:</strong> ${med.time}</p>
          <p><strong>Recurrence:</strong> ${recurrenceText}</p>
          <button onclick="editMedicine('${med.id}')">Edit</button>
          <button onclick="deleteMedicine('${med.id}')">Delete</button>
        `;
        medicineList.appendChild(card);
      });
    }

    window.openModal = () => {
      modal.style.display = "flex";
      // Reset form on open
      medNameInput.value = '';
      medDoseInput.value = '';
      medTimeInput.value = '';
      document.querySelector('input[name="recurrence"][value="daily"]').checked = true;
      daysCheckboxes.style.display = "none";
      document.querySelectorAll('input[name="day"]').forEach(cb => cb.checked = false);
    };

    window.closeModal = () => {
      modal.style.display = "none";
    };

    window.toggleDays = (show) => {
        if (show) {
            daysCheckboxes.style.display = "flex";
        } else {
            daysCheckboxes.style.display = "none";
        }
    };

    window.saveMedicine = async () => {
      const name = medNameInput.value;
      const dose = medDoseInput.value;
      const time = medTimeInput.value;
      const recurrence = document.querySelector('input[name="recurrence"]:checked').value;
      
      let days = [];
      if (recurrence === "specific") {
          document.querySelectorAll('input[name="day"]:checked').forEach(cb => days.push(cb.value));
      }

      if (!name || !dose || !time) {
        alert("Please fill all fields.");
        return;
      }
      if (recurrence === "specific" && days.length === 0) {
          alert("Please select at least one day.");
          return;
      }

      try {
        await addDoc(collection(db, "medicines"), {
          userId: user.uid,
          name: name,
          dose: dose,
          time: time,
          recurrence: recurrence, // "daily" or "specific"
          days: days, // array of selected days
          createdAt: new Date()
        });
        closeModal();
      } catch (e) {
        console.error("Error adding document: ", e);
        alert("Error adding medicine.");
      }
    };

    window.editMedicine = async (id) => {
      const newName = prompt("Enter new name:");
      if (newName) {
        const medRef = doc(db, "medicines", id);
        await updateDoc(medRef, {
          name: newName
        });
      }
    };

    window.deleteMedicine = async (id) => {
      if (confirm("Are you sure you want to delete this medicine?")) {
        await deleteDoc(doc(db, "medicines", id));
      }
    };

    window.logout = async () => {
      await signOut(auth);
    };
  </script>
</body>
</html>